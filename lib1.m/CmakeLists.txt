cmake_minimum_required(VERSION 3.15.0)
project(lib1.m)

# compile definitions
add_library(lib1_obj OBJECT src/lib1help.cpp)
target_include_directories(lib1_obj PUBLIC include/)
target_include_directories(lib1_obj PRIVATE $<TARGET_PROPERTY:lib2_obj,INCLUDE_DIRECTORIES>)
target_compile_definitions(lib1_obj PRIVATE __LIB1)

# static lib for Link1st (resolve cyclic dep)
add_library(lib1_s $<TARGET_OBJECTS:lib1_obj>)
target_link_libraries(lib1_s PUBLIC lib2_s)
set_target_properties(lib1_s PROPERTIES STATIC_LIBRARY_OPTIONS /DEF)
set_target_properties(lib1_s PROPERTIES OUTPUT_NAME lib1)

# shared lib for link2nd (final dll)
add_library(lib1_d SHARED $<TARGET_OBJECTS:lib1_obj>)
target_include_directories(lib1_d PUBLIC include/)
target_link_libraries(lib1_d PRIVATE lib1_s)
set_target_properties(lib1_d PROPERTIES RUNTIME_OUTPUT_NAME lib1)

# install directives : where to put final files
add_library(lib1 ALIAS lib1_d) 
install(TARGETS lib1_d RUNTIME DESTINATION ${CMAKE_INSTALL_PREFIX}/bin)
install(TARGETS lib1_d LIBRARY DESTINATION ${CMAKE_INSTALL_PREFIX}/lib)
install(FILES $<TARGET_PDB_FILE:lib1_d> DESTINATION ${CMAKE_INSTALL_PREFIX}/bin OPTIONAL)

